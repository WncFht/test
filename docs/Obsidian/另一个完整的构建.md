---
title: å¦ä¸€ä¸ªå®Œæ•´çš„æ„å»º
date: 2024-11-16T20:34:02+0800
modify: 2024-12-06T00:14:39+0800
categories: graph
dir: Obsidian
share: true
tags:
  - graph
---

```thinking
åŸºäºDockerç¯å¢ƒå’Œç½‘ç»œé™åˆ¶ï¼Œéœ€è¦é‡æ–°ç»„ç»‡æ­¥éª¤ï¼š

1. éœ€è¦åœ¨æœ¬æœºé¢„å…ˆä¸‹è½½:
- æ•°æ®é›†æ–‡ä»¶
- é¢„è®­ç»ƒæ¨¡å‹
- apex å’Œ normalspeed æºç 
- FFB6D ä»£ç 

2. æ„å»ºæ—¶éœ€è¦:
- å°†æ‰€æœ‰é¢„ä¸‹è½½çš„æ–‡ä»¶å¤åˆ¶è¿›å®¹å™¨
- æ­£ç¡®é…ç½®ç¼–è¯‘ç¯å¢ƒ
- æŒ‰é¡ºåºå®‰è£…ä¾èµ–

è®©æˆ‘ç»„ç»‡ä¸€ä¸ªå®Œæ•´çš„è§£å†³æ–¹æ¡ˆ...
```

å¥½çš„ï¼Œè®©æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥ï¼š

[GitHub - dongyubin/DockerHub: 2024å¹´11æœˆæ›´æ–°ï¼Œç›®å‰å›½å†…å¯ç”¨Dockeré•œåƒæºæ±‡æ€»ï¼ŒDockerHubå›½å†…é•œåƒåŠ é€Ÿåˆ—è¡¨ï¼ŒğŸš€DockerHubé•œåƒåŠ é€Ÿå™¨](https://github.com/dongyubin/DockerHub)

1. é¦–å…ˆåœ¨æœ¬æœºåˆ›å»ºå·¥ä½œç›®å½•å¹¶ä¸‹è½½æ‰€éœ€æ–‡ä»¶ï¼š

```bash
# åˆ›å»ºä¸»å·¥ä½œç›®å½•
mkdir -p ~/ffb6d_docker
cd ~/ffb6d_docker

# åˆ›å»ºå­ç›®å½•
mkdir -p downloads  # ç”¨äºå­˜æ”¾ä¸‹è½½çš„æ–‡ä»¶
mkdir -p datasets   # ç”¨äºå­˜æ”¾æ•°æ®é›†
mkdir -p train_log  # ç”¨äºå­˜æ”¾è®­ç»ƒæ—¥å¿—
mkdir -p models     # ç”¨äºå­˜æ”¾æ¨¡å‹

# ä¸‹è½½ FFB6D ä»£ç 
git clone https://github.com/ethnhe/FFB6D.git code

# ä¸‹è½½ apex
cd downloads
git clone https://github.com/NVIDIA/apex.git

# ä¸‹è½½ normalspeed
git clone https://github.com/hfutcgncas/normalspeed.git

# ä¸‹è½½æ•°æ®é›†
cd ../datasets
wget https://bop.felk.cvut.cz/media/data/lm_test_all.zip
wget https://bop.felk.cvut.cz/media/data/lm_train_pbr.zip
wget https://storage.googleapis.com/mediapipe-assets/ffb6d_lm_preprocessed_all.zip

# ä¸‹è½½é¢„è®­ç»ƒæ¨¡å‹
cd ../models
wget https://storage.googleapis.com/mediapipe-assets/ffb6d_lm_pretrained.zip
```

2. åˆ›å»º Dockerfileï¼š

```dockerfile
FROM nvcr.io/nvidia/cuda:11.0-cudnn8-devel-ubuntu20.04

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONPATH=/workspace/code
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=$CUDA_HOME/bin:$PATH
ENV LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH

WORKDIR /workspace

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    python3.8 \
    python3.8-dev \
    python3-pip \
    git \
    cmake \
    build-essential \
    libopencv-dev \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½® Python 3.8 ä¸ºé»˜è®¤ç‰ˆæœ¬
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.8 1
RUN update-alternatives --set python3 /usr/bin/python3.8

# å‡çº§ pip
RUN python3 -m pip install --upgrade pip

# å®‰è£… PyTorch
RUN pip3 install torch==1.7.1+cu110 torchvision==0.8.2+cu110 -f https://download.pytorch.org/whl/torch_stable.html

# åˆ†æ­¥å®‰è£… Python ä¾èµ–ä»¥ä¾¿äºè°ƒè¯•
RUN pip3 install opencv-python==4.4.0.46
RUN pip3 install pytest-runner==5.3.1
RUN pip3 install matplotlib==3.3.4
RUN pip3 install tqdm==4.64.0
RUN pip3 install tensorboard==2.10.1
RUN pip3 install transforms3d==0.3.1
# ä½¿ç”¨è¾ƒæ–°ç‰ˆæœ¬çš„ open3d
RUN pip3 install open3d==0.10.0.0
RUN pip3 install scipy==1.7.3
RUN pip3 install numpy==1.19.5

# å¤åˆ¶é¢„ä¸‹è½½çš„æ–‡ä»¶
COPY downloads/apex /workspace/apex
COPY downloads/normalspeed /workspace/normalspeed
COPY code /workspace/code

# å®‰è£… apex
RUN cd /workspace/apex && \
    pip install -v --disable-pip-version-check --no-cache-dir --global-option="--cpp_ext" --global-option="--cuda_ext" ./

# å®‰è£… normalspeed
RUN cd /workspace/normalspeed && \
    python3 setup.py build_ext --inplace && \
    python3 setup.py install

WORKDIR /workspace/code
```

3. åˆ›å»º docker-compose. ymlï¼š

```yaml
version: '3'
services:
  ffb6d:
    build: .
    image: ffb6d:latest
    container_name: ffb6d_container
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - ./datasets:/workspace/code/datasets
      - ./train_log:/workspace/code/train_log
      - ./models:/workspace/code/models
    shm_size: '8gb'
    tty: true
    stdin_open: true
```

```
apt-get install -y nano
apt-get install -y vim
pip install pybind
apt-get update && apt-get install -y \ cmake \ g++ \ libboost-all-dev \ libeigen3-dev
```

4. åˆ›å»ºæ„å»ºå’Œè¿è¡Œè„šæœ¬ `build_and_run.sh` ï¼š

```bash
#!/bin/bash

# è§£å‹æ•°æ®é›†
cd datasets
unzip -n lm_test_all.zip
unzip -n lm_train_pbr.zip
unzip -n ffb6d_lm_preprocessed_all.zip

# è§£å‹é¢„è®­ç»ƒæ¨¡å‹
cd ../models
unzip -n ffb6d_lm_pretrained.zip

# æ„å»ºå’Œè¿è¡Œå®¹å™¨
docker-compose up --build -d
docker exec -it ffb6d_container bash
```

5. æ‰§è¡Œæ„å»ºå’Œè¿è¡Œï¼š

```bash
chmod +x build_and_run.sh
./build_and_run.sh
```

6. åœ¨å®¹å™¨å†…éªŒè¯ç¯å¢ƒï¼š

```bash
# éªŒè¯ CUDA
python3 -c "import torch; print('CUDA available:', torch.cuda.is_available()); print('CUDA version:', torch.version.cuda)"

# éªŒè¯ apex
python3 -c "from apex import amp; print('APEX å®‰è£…æˆåŠŸ')"

# éªŒè¯ normalspeed
python3 -c "import normalspeed as ns; print('normalspeed å®‰è£…æˆåŠŸ')"
```

7. å¼€å§‹è®­ç»ƒï¼š

```bash
# è®­ç»ƒå•ä¸ªç±»åˆ«ï¼ˆä¾‹å¦‚ apeï¼‰
python3 train_lm.py --cls ape --gpu "0"

# æˆ–è®­ç»ƒæ‰€æœ‰ç±»åˆ«
python3 train_lm.py --cls all --gpu "0"
```

æ³¨æ„äº‹é¡¹ï¼š

1. ç›®å½•ç»“æ„åº”è¯¥æ˜¯ï¼š

```
ffb6d_docker/
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ build_and_run.sh
â”œâ”€â”€ downloads/
â”‚   â”œâ”€â”€ apex/
â”‚   â””â”€â”€ normalspeed/
â”œâ”€â”€ code/
â”œâ”€â”€ datasets/
â”œâ”€â”€ models/
â””â”€â”€ train_log/
```

2. å¦‚æœä¸‹è½½é€Ÿåº¦æ…¢ï¼Œå¯ä»¥ä½¿ç”¨å›½å†…é•œåƒï¼š

```bash
# åœ¨ Dockerfile ä¸­æ·»åŠ 
RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
```

3. æ•°æ®é›†å’Œæ¨¡å‹å¤ªå¤§å¯ä»¥ä½¿ç”¨è¿…é›·ç­‰ä¸‹è½½å·¥å…·ï¼Œç„¶åç§»åŠ¨åˆ°å¯¹åº”ç›®å½•ã€‚

éœ€è¦æˆ‘è¯¦ç»†è§£é‡Šä»»ä½•æ­¥éª¤å—ï¼Ÿæˆ–è€…ä½ é‡åˆ°äº†ä»€ä¹ˆå…·ä½“é—®é¢˜ï¼Ÿ